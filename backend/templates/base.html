<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>{{ title }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .star-filter i {
      font-size: 24px;
      color: #ccc;
      cursor: pointer;
      margin-right: 4px;
    }
    .star-filter i.fas {
      color: #f5a623;
    }
  </style>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Kanit&family=Montserrat&family=Open+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="initial-mode">
  <header class="header-container">
    <div class="title-group">
      <img src="{{ url_for('static', filename='images/Godmother.png') }}" alt="Logo" class="logo-image">
      <div class="title-container">
        <h1 class="main-title">Dairy Godmothers</h1>
        <img src="{{ url_for('static', filename='images/Godmother.png') }}" alt="Logo small" class="logo-small">
      </div>
    </div>
    <div class="search-bar">
      <input id="search-input" placeholder="Search for an Ice Cream Flavor">
      <button id="search-button">Find My Flavors</button>
    </div>
    <div class="filters-inline">
      <div class="filter-item">
        <label>Minimum Rating:</label>
        <div class="star-filter" id="rating-filter">
          <i class="far fa-star" data-value="1"></i>
          <i class="far fa-star" data-value="2"></i>
          <i class="far fa-star" data-value="3"></i>
          <i class="far fa-star" data-value="4"></i>
          <i class="far fa-star" data-value="5"></i>
        </div>
      </div>
      <div class="filter-item">
        <label for="allergy-toggle">Allergies:</label>
        <div class="allergy-dropdown">
          <button id="allergy-toggle">Select‚Ä¶ ‚ñæ</button>
          <div class="dropdown-content">
            <label><input type="checkbox" name="allergy" value="nuts"> Nuts</label>
            <label><input type="checkbox" name="allergy" value="dairy"> Dairy</label>
            <label><input type="checkbox" name="allergy" value="gluten"> Gluten</label>
            <label><input type="checkbox" name="allergy" value="soy"> Soy</label>
            <label><input type="checkbox" name="allergy" value="eggs"> Eggs</label>
          </div>
        </div>
      </div>
    </div>
  </header>
  <div class="content">
    <aside class="filters-sidebar">
      <h2>Filters</h2>
      <div class="filter-item">
        <label>Minimum Rating:</label>
        <div class="star-filter" id="rating-filter-2">
          <i class="far fa-star" data-value="1"></i>
          <i class="far fa-star" data-value="2"></i>
          <i class="far fa-star" data-value="3"></i>
          <i class="far fa-star" data-value="4"></i>
          <i class="far fa-star" data-value="5"></i>
        </div>
      </div>
      <div class="filter-item">
        <label>Allergies:</label>
        <div class="checkbox-group">
          <label><input type="checkbox" name="allergy-2" value="nuts"> Nuts</label>
          <label><input type="checkbox" name="allergy-2" value="dairy"> Dairy</label>
          <label><input type="checkbox" name="allergy-2" value="gluten"> Gluten</label>
          <label><input type="checkbox" name="allergy-2" value="soy"> Soy</label>
          <label><input type="checkbox" name="allergy-2" value="eggs"> Eggs</label>
        </div>
      </div>
    </aside>
    <main class="results-section">
      <h2 id="results-title" style="display:none;">Ice Cream Recommendations</h2>
      <div id="answer-box"></div>
    </main>
  </div>

  <div id="popup-modal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closePopup()">&times;</span>
      <h3 style="margin-bottom:1em;">More information about recommendation</h3>
      <div id="popup-content"></div>
    </div>
  </div>

  <script>
    const brandUrls = {
      "Ben and Jerry's": "https://www.benjerry.com/",
      "Haagen Dazs": "https://www.icecream.com/us/en/brands/haagen-dazs",
      "Talenti": "https://www.talentigelato.com/us/en/home.html",
      "Breyers": "https://www.breyers.com/us/en/home.html"
    };
    let firstSearch = true;
    let ratingFilter = 0;

    document.getElementById('allergy-toggle').addEventListener('click', () =>
      document.querySelector('.dropdown-content').classList.toggle('show')
    );
    window.addEventListener('click', e => {
      if (!e.target.matches('#allergy-toggle')) {
        document.querySelector('.dropdown-content').classList.remove('show');
      }
    });

    function updateStarFilter(filterId) {
      document.querySelectorAll(`#${filterId} i`).forEach(star => {
        const v = +star.dataset.value;
        if (ratingFilter >= v)             star.className = 'fas fa-star';
        else if (ratingFilter >= v - 0.5)   star.className = 'fas fa-star-half-alt';
        else                                star.className = 'far fa-star';
      });
    }
    document.querySelectorAll('.star-filter i').forEach(star => {
      star.addEventListener('click', e => {
        const v = +star.dataset.value;
        const half = (e.offsetX < star.clientWidth / 2);
        ratingFilter = half ? v - 0.5 : v;
        updateStarFilter(star.parentElement.id);
        clearResults();
      });
    });

    function clearResults() {
      document.getElementById("answer-box").innerHTML = "";
      document.getElementById("results-title").style.display = "none";
    }
    function toggleDetails(id) {
      const el = document.getElementById(id);
      el.style.display = el.style.display === 'none' ? 'block' : 'none';
    }
    function openPopup(id) {
      const content = explanationMap[id];
      if (!content) return;
      let html = `
        <p>When you search for a flavor, we don‚Äôt just match words directly. Instead, we use latent dimensions ‚Äî hidden themes our system has learned.</p>
        <hr/>
      `;
      Object.entries(content).forEach(([field,data]) => {
        const title = field.charAt(0).toUpperCase()+field.slice(1);
        html += `
          <h4>${title}</h4>
          <p><em>Themes:</em> ${data.themes.join(', ')}</p>
          <canvas id="chart-${id}-${field}" width="300" height="300"></canvas>
        `;
      });
      document.getElementById("popup-content").innerHTML = html;
      document.getElementById("popup-modal").style.display = "flex";
      Object.entries(content).forEach(([field,data]) => {
        new Chart(
          document.getElementById(`chart-${id}-${field}`).getContext('2d'),
          {
            type: 'radar',
            data: {
              labels: data.themes,
              datasets: [{
                label: `${field} match`,
                data: data.scores,
                fill: true,
                backgroundColor: 'rgba(209,73,91,0.3)',
                borderColor: 'rgb(209,73,91)',
                pointRadius: 5,
              }]
            },
            options: { plugins:{legend:{display:false}} }
          }
        );
      });
    }
    function closePopup() {
      document.getElementById('popup-modal').style.display = 'none';
    }

    const explanationMap = {};
    function answerBoxTemplate(id,brand,title,desc,ing,rating,score) {
      return `
        <div class="result">
          <div class="result-header" onclick="toggleDetails('details-${id}')">
            <h3>${brand} ${title} <span>üç®</span></h3>
            <div class="similarity-score"><strong>SVD score: ${score.toFixed(2)}</strong></div>
          </div>
          <div class="result-details" id="details-${id}" style="display:none">
            <p><strong>Description:</strong> ${desc}</p>
            <p><strong>Ingredients:</strong> ${ing}</p>
            <p><strong>Rating:</strong> ${rating}</p>
            <button class="popup-button" onclick="openPopup('${id}')">More information</button>
            <a href="${brandUrls[brand]}" target="_blank" class="popup-button">Visit site</a>
          </div>
        </div>
      `;
    }

    function fetchFlavors() {
      const q = document.getElementById("search-input").value.trim();
      if (!q) return alert("Please enter a flavor.");
      clearResults();
      if (firstSearch) {
        updateStarFilter('rating-filter-2');
        document.querySelectorAll('input[name="allergy"]').forEach(cb => {
          const m = document.querySelector(`input[name="allergy-2"][value="${cb.value}"]`);
          if (m) m.checked = cb.checked;
        });
        document.body.classList.replace('initial-mode','results-mode');
        firstSearch = false;
      }
      const al = Array.from(document.querySelectorAll('input[name^="allergy"]:checked')).map(cb=>cb.value);
      fetch("/flavors?"+new URLSearchParams({ title:q, min_rating:ratingFilter, allergies:al.join(',') }))
        .then(r=>r.json()).then(data=>{
          const box = document.getElementById("answer-box");
          if (!data.length) box.innerHTML="<p>No results found.</p>";
          else {
            document.getElementById("results-title").style.display="block";
            data.forEach(r=>{
              explanationMap[r.safeId]=r.explanation;
              box.insertAdjacentHTML('beforeend',
                answerBoxTemplate(r.safeId,r.brand,r.title,r.description,r.ingredients_y,r.rating,r.composite_score)
              );
            });
          }
        });
    }
    document.getElementById('search-button').addEventListener('click',fetchFlavors);
  </script>
</body>
</html>
