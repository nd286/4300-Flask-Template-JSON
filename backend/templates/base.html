<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>{{ title }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="initial-mode">
  <header class="header-container">
    <div class="filters-inline">
      <div class="filter-item">
        <label>Minimum Rating:</label>
        <div id="rating-filter" class="star-rating" data-rating="0"></div>
        <span id="rating-filter-value">Any</span>
      </div>
      <div class="filter-item">
        <label for="allergy-toggle">Allergies:</label>
      </div>
    </div>
  </header>

  <div class="content">
    <aside class="filters-sidebar">
      <h2>Filters</h2>
      <div class="filter-item">
        <label>Minimum Rating:</label>
        <div id="rating-filter-2" class="star-rating" data-rating="0"></div>
        <span id="rating-filter-2-value">Any</span>
      </div>
      <div class="filter-item">
        <label>Allergies:</label>
      </div>
    </aside>
    <main class="results-section">
      <h2 id="results-title" style="display:none;">
        Ice Cream Recommendations
      </h2>
      <div id="answer-box"></div>
    </main>
  </div>


  <script>
    function initStarRating(elem, display) {
      const bg = document.createElement('div');
      bg.className = 'star-bg';
      const fg = document.createElement('div');
      fg.className = 'star-fg';
      elem.appendChild(bg);
      elem.appendChild(fg);

      function updateFill(x) {
        const rect = elem.getBoundingClientRect();
        x = Math.max(0, Math.min(x, rect.width));
        let rating = Math.round((x/rect.width*5)*2)/2;
        fg.style.width = (rating/5*100) + '%';
        return rating;
      }

      elem.addEventListener('mousemove', e => updateFill(e.clientX - elem.getBoundingClientRect().left));
      elem.addEventListener('mouseout', () => {
        const saved = parseFloat(elem.dataset.rating) || 0;
        fg.style.width = (saved/5*100)+'%';
      });
      elem.addEventListener('click', e => {
        const rating = updateFill(e.clientX - elem.getBoundingClientRect().left);
        elem.dataset.rating = rating;
        display.textContent = rating>0 ? rating+' stars' : 'Any';
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      const rf1 = document.getElementById('rating-filter');
      const rf1v = document.getElementById('rating-filter-value');
      const rf2 = document.getElementById('rating-filter-2');
      const rf2v = document.getElementById('rating-filter-2-value');
      initStarRating(rf1, rf1v);
      initStarRating(rf2, rf2v);


      let firstSearch = true;
      function clearResults() {
        document.getElementById('answer-box').innerHTML = '';
        document.getElementById('results-title').style.display = 'none';
      }
      function toggleDetails(id) {
        const el = document.getElementById(id);
        el.style.display = el.style.display==='none' ? 'block' : 'none';
      }
      window.toggleDetails = toggleDetails;

      const explanationMap = {};

      function answerBoxTemplate(id, brand, title, desc, ing, rating, score) {
        return `
        <div class="result">
          <div class="result-header" onclick="toggleDetails('details-${id}')">
            <h3>${brand} ${title}</h3>
            <div class="header-right">
              <span class="score">${score.toFixed(2)}</span>
              <span class="toggle-icon">üç®</span>
            </div>
          </div>
          <div class="result-details" id="details-${id}" style="display:none;">
            <p><strong>Description:</strong> ${desc}</p>
            <p><strong>Ingredients:</strong> ${ing}</p>
            <p><strong>Rating:</strong> ${rating}</p>
            <button class="popup-button" onclick="openPopup('${id}')">
              More information
            </button>
            <a href="${brandUrls[brand]}" target="_blank"
               class="popup-button">Visit site</a>
          </div>
        </div>`;
      }
      window.answerBoxTemplate = answerBoxTemplate;


      function fetchFlavors() {
        const query = document.getElementById('search-input').value.trim();
        if (!query) { alert('Please enter a flavor.'); return; }

        const inResultsMode = document.body.classList.contains('results-mode');
        const ratingElem = inResultsMode ? rf2 : rf1;
        const rating = parseFloat(ratingElem.dataset.rating) || 0;
        const allergySelector = inResultsMode
          ? 'input[name="allergy-2"]:checked'
          : 'input[name="allergy"]:checked';
        const allergies = Array.from(document.querySelectorAll(allergySelector))
                               .map(cb=>cb.value);

        clearResults();
        if (firstSearch) {
          const initRating = rf1.dataset.rating;
          if (initRating) {
            rf2.dataset.rating = initRating;
            rf2v.textContent = initRating+' stars';
            rf2.querySelector('.star-fg').style.width =
              (initRating/5*100)+'%';
          }
          document.body.classList.replace('initial-mode','results-mode');
          firstSearch = false;
        }

        fetch('/flavors?' + new URLSearchParams({
          title: query, min_rating: rating, allergies: allergies.join(',')
        }))
        .then(r=>r.json())
        .then(data=>{
          const box = document.getElementById('answer-box');
          if (data.length) {
            document.getElementById('results-title').style.display='block';
            data.forEach(r=>{
              explanationMap[r.safeId] = r.explanation;
              box.insertAdjacentHTML('beforeend',
                answerBoxTemplate(
                  r.safeId, r.brand, r.title,
                  r.description, r.ingredients_y,
                  r.rating, r.composite_score
                )
              );
            });
          } else {
            box.innerHTML = '<p>No results found.</p>';
          }
        });
      }
      window.fetchFlavors = fetchFlavors;

    });
  </script>
</body>
</html>
