<!-- base.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>{{ title }}</title>
  <link rel="stylesheet" href="{{ url_for('static',filename='style.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Kanit&family=Montserrat&family=Open+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="initial-mode">
  <header class="header-container">
    <img src="{{ url_for('static',filename='images/Godmother.png') }}" alt="Logo" class="logo-image">
    <div class="title-container">
      <h1 class="main-title">Dairy Godmothers</h1>
      <img src="{{ url_for('static',filename='images/Godmother.png') }}" alt="Logo small" class="logo-small">
    </div>
    <div class="search-bar">
      <input id="search-input" placeholder="Search for an Ice Cream Flavor">
      <button id="search-button">Find My Flavors</button>
    </div>
    <div class="filters-inline">
      <div class="filter-item">
        <label for="rating-filter">Minimum Rating:</label>
        <select id="rating-filter">
          <option value="0">Any</option>
          <option value="1">1+ stars</option>
          <option value="2">2+ stars</option>
          <option value="3">3+ stars</option>
          <option value="4">4+ stars</option>
          <option value="5">5 stars only</option>
        </select>
      </div>
      <div class="filter-item">
        <label for="allergy-toggle">Allergies:</label>
        <div class="allergy-dropdown">
          <button id="allergy-toggle">Select‚Ä¶ ‚ñæ</button>
          <div class="dropdown-content">
            <label><input type="checkbox" name="allergy" value="nuts"> Nuts</label>
            <label><input type="checkbox" name="allergy" value="dairy"> Dairy</label>
            <label><input type="checkbox" name="allergy" value="gluten"> Gluten</label>
            <label><input type="checkbox" name="allergy" value="soy"> Soy</label>
            <label><input type="checkbox" name="allergy" value="eggs"> Eggs</label>
          </div>
        </div>
      </div>
    </div>
  </header>
  <div class="content">
    <aside class="filters-sidebar">
      <h2>Filters</h2>
      <div class="filter-item">
        <label for="rating-filter-2">Minimum Rating:</label>
        <select id="rating-filter-2">
          <option value="0">Any</option>
          <option value="1">1+ stars</option>
          <option value="2">2+ stars</option>
          <option value="3">3+ stars</option>
          <option value="4">4+ stars</option>
          <option value="5">5 stars only</option>
        </select>
      </div>
      <div class="filter-item">
        <label>Allergies:</label>
        <div class="checkbox-group">
          <label><input type="checkbox" name="allergy-2" value="nuts"> Nuts</label>
          <label><input type="checkbox" name="allergy-2" value="dairy"> Dairy</label>
          <label><input type="checkbox" name="allergy-2" value="gluten"> Gluten</label>
          <label><input type="checkbox" name="allergy-2" value="soy"> Soy</label>
          <label><input type="checkbox" name="allergy-2" value="eggs"> Eggs</label>
        </div>
      </div>
    </aside>
    <main class="results-section">
      <h2 id="results-title" style="display:none;">Ice Cream Recommendations</h2>
      <div id="answer-box"></div>
    </main>
  </div>
  <div id="popup-modal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closePopup()">&times;</span>
      <div id="popup-content"></div>
    </div>
  </div>
  <script>
    const brandUrls={"Ben and Jerry's":"https://www.benjerry.com/","Haagen Dazs":"https://www.icecream.com/us/en/brands/haagen-dazs","Talenti":"https://www.talentigelato.com/us/en/home.html","Breyers":"https://www.breyers.com/us/en/home.html"};
    let firstSearch=true;
    document.getElementById('allergy-toggle').addEventListener('click',()=>document.querySelector('.dropdown-content').classList.toggle('show'));
    window.addEventListener('click',e=>{if(!e.target.matches('#allergy-toggle'))document.querySelector('.dropdown-content').classList.remove('show')});
    function clearResults(){document.getElementById("answer-box").innerHTML="";document.getElementById("results-title").style.display="none"}
    function toggleDetails(id){const e=document.getElementById(id);e.style.display=e.style.display==='none'?'block':'none'}
    function capIng(txt){return txt.toLowerCase().split(',').map(x=>x.trim()).map(x=>x.charAt(0).toUpperCase()+x.slice(1)).join(', ')}
    function answerBoxTemplate(id,b,t,d,i,r){return`<div class="result"><div class="result-header" onclick="toggleDetails('details-${id}')"><h3 class="episode-title">${b} ${t} <span class="toggle-icon">üç®</span></h3></div><div class="result-details" id="details-${id}" style="display:none;"><p><strong>Description:</strong> ${d}</p><p><strong>Ingredients:</strong> ${capIng(i)}</p><p><strong>Rating:</strong> ${r}</p><button class="popup-button" onclick="openPopup('${id}')">More information about recommendation</button><a href="${brandUrls[b]}" target="_blank" class="popup-button" style="text-decoration:none;">${b} website</a></div></div>`}
    const explanationMap={};
    function openPopup(id){
      const c=explanationMap[id];if(!c)return
      let html=`<h3>Matched themes with scores:</h3>`
      Object.entries(c).forEach(([f,d])=>{
        const T=f.charAt(0).toUpperCase()+f.slice(1)
        html+=`<h4>${T}:</h4><canvas id="chart-${id}-${f}" width="400" height="400"></canvas>`
      })
      html+=`<hr style="margin:1em 0;"><p>When you search for a flavor, we don‚Äôt just match words directly. Instead, we use latent dimensions ‚Äî hidden themes our system has learned from patterns across all descriptions, ingredients, and reviews.</p><p>Below you see each theme plotted with how strongly it matched your query.</p>`
      document.getElementById("popup-content").innerHTML=html
      document.getElementById("popup-modal").style.display="flex"
      Object.entries(c).forEach(([f,d])=>{
        const ctx=document.getElementById(`chart-${id}-${f}`).getContext('2d')
        new Chart(ctx,{type:'radar',data:{labels:d.themes,datasets:[{label:`${f} match`,data:d.scores,fill:true}]},options:{scales:{r:{beginAtZero:true}},plugins:{legend:{display:false}}}})
      })
    }
    function closePopup(){document.getElementById('popup-modal').style.display='none'}
    function fetchFlavors(){
      const q=document.getElementById("search-input").value.trim()
      const rm=document.body.classList.contains('results-mode')
      const rating=rm?document.getElementById("rating-filter-2").value:document.getElementById("rating-filter").value
      const selector=rm?'input[name="allergy-2"]:checked':'input[name="allergy"]:checked'
      const al=Array.from(document.querySelectorAll(selector)).map(cb=>cb.value)
      if(!q)return alert("Please enter a flavor.")
      clearResults()
      if(firstSearch){
        document.getElementById('rating-filter-2').value=document.getElementById('rating-filter').value
        document.querySelectorAll('input[name="allergy"]').forEach(cb=>{const m=document.querySelector(`input[name="allergy-2"][value="${cb.value}"]`);if(m)m.checked=cb.checked})
        document.body.classList.replace('initial-mode','results-mode')
        firstSearch=false
      }
      fetch("/flavors?"+new URLSearchParams({title:q,min_rating:rating,allergies:al.join(',')})).then(r=>r.json()).then(data=>{
        const box=document.getElementById("answer-box")
        if(data.length){
          document.getElementById("results-title").style.display="block"
          data.forEach(r=>{explanationMap[r.safeId]=r.explanation;box.insertAdjacentHTML('beforeend',answerBoxTemplate(r.safeId,r.brand,r.title,r.description,r.ingredients_y,r.rating))})
        } else box.innerHTML="<p>No results found.</p>"
      })
    }
    document.getElementById('search-input').addEventListener('input',clearResults)
    document.getElementById('rating-filter').addEventListener('change',clearResults)
    document.querySelectorAll('input[name="allergy"]').forEach(cb=>cb.addEventListener('change',clearResults))
    document.getElementById('search-button').addEventListener('click',fetchFlavors)
  </script>
</body>
</html>
